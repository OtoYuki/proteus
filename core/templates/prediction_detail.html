<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ prediction.sequence.sequence_name }} - Proteus</title>
    <!-- Bootstrap for styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Include NGL Viewer -->
    <script src="https://cdn.jsdelivr.net/gh/arose/ngl@v2.0.0-dev.37/dist/ngl.js"></script>
    <style>
        body {
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            margin-bottom: 20px;
        }

        #viewer {
            width: 100%;
            height: 500px;
            position: relative;
        }

        .metadata-card {
            margin-bottom: 20px;
        }

        .badge {
            font-size: 0.9em;
        }

        .sequence-box {
            font-family: monospace;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            word-break: break-all;
        }
    </style>
    {% load static %}
    <script src="{% static 'js/gromacs.js' %}"></script>
</head>

<body>
    <!-- Add a hidden element with the prediction ID -->
    <div id="prediction-id" data-id="{{ prediction.prediction_id }}" style="display: none;"></div>
    <div class="container">
        <div class="row mb-3">
            <div class="col">
                <h1>{{ prediction.sequence.sequence_name }}</h1>
                <p>
                    <a href="{% url 'prediction_list' %}" class="btn btn-outline-secondary">
                        &larr; Back to Predictions
                    </a>
                </p>
            </div>
        </div>

        <div class="row">
            <!-- Prediction Metadata -->
            <div class="col-md-4">
                <div class="card metadata-card">
                    <div class="card-header">Prediction Details</div>
                    <div class="card-body">
                        <dl>
                            <dt>Status</dt>
                            <dd>
                                {% if prediction.status == "pending" %}
                                <span class="badge bg-warning">Pending</span>
                                {% elif prediction.status == "running" %}
                                <span class="badge bg-info">Running</span>
                                {% elif prediction.status == "completed" %}
                                <span class="badge bg-success">Completed</span>
                                {% elif prediction.status == "failed" %}
                                <span class="badge bg-danger">Failed</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ prediction.status }}</span>
                                {% endif %}
                            </dd>

                            <dt>Prediction Date</dt>
                            <dd>{{ prediction.prediction_date|date:"F d, Y H:i" }}</dd>

                            <dt>Model Version</dt>
                            <dd>{{ prediction.model_version }}</dd>

                            {% if prediction.plddt_score %}
                            <dt>pLDDT Score</dt>
                            <dd>{{ prediction.plddt_score|floatformat:2 }}</dd>
                            {% endif %}
                        </dl>
                    </div>
                </div>

                <div class="card metadata-card">
                    <div class="card-header">Sequence Information</div>
                    <div class="card-body">
                        <dl>
                            <dt>Length</dt>
                            <dd>{{ prediction.sequence.sequence_length }} amino acids</dd>

                            {% if prediction.sequence.organism %}
                            <dt>Organism</dt>
                            <dd>{{ prediction.sequence.organism }}</dd>
                            {% endif %}

                            {% if prediction.sequence.description %}
                            <dt>Description</dt>
                            <dd>{{ prediction.sequence.description }}</dd>
                            {% endif %}
                        </dl>

                        <h6>FASTA Sequence</h6>
                        <div class="sequence-box">
                            >{{ prediction.sequence.sequence_name }}<br>
                            {{ prediction.sequence.sequence_fasta }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3D Structure Viewer -->
            <div class="col-md-8">
                {% if prediction.status == "completed" and pdb_file_exists %}
                <div id="viewer" class="mb-2"></div>
                <div class="d-flex justify-content-between">
                    <button id="runSimulation" class="btn btn-primary">
                        Run GROMACS Simulation
                    </button>
                    <a href="{% url 'serve_pdb' prediction.prediction_id %}" class="btn btn-sm btn-outline-secondary"
                        download>
                        Download PDB File
                    </a>
                </div>
                {% else %}
                <div class="card">
                    <div class="card-body text-center py-5">
                        {% if prediction.status == "failed" %}
                        <h4 class="text-danger">Prediction Failed</h4>
                        <p>The structure prediction could not be completed. Please try again or contact support.</p>
                        {% elif prediction.status == "pending" or prediction.status == "running" %}
                        <h4>Prediction In Progress</h4>
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">This may take several minutes. The page will automatically refresh.</p>
                        {% else %}
                        <h4>Structure Not Available</h4>
                        <p>The structure file could not be located. Please contact support.</p>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script>
        {% if prediction.status == "completed" and pdb_file_exists %}
        document.addEventListener('DOMContentLoaded', function () {
            console.log("Initializing NGL viewer");

            // Create NGL Stage object
            const stage = new NGL.Stage('viewer');

            // Handle window resizing
            window.addEventListener('resize', function () {
                stage.handleResize();
            });

            // Load PDB file with explicit format
            const pdbUrl = "{% url 'serve_pdb' prediction.prediction_id %}";
            console.log("Loading PDB from:", pdbUrl);

            // Use loadFile with explicit format parameter
            stage.loadFile(pdbUrl, { ext: 'pdb' }).then(function (component) {
                console.log("PDB file loaded successfully");

                // Add representations
                component.addRepresentation("cartoon", {
                    colorScheme: "chainindex"
                });

                component.addRepresentation("licorice", {
                    sele: "hetero",
                    multipleBond: "symmetric"
                });

                // Center view
                stage.autoView();
            }).catch(function (error) {
                console.error("Error loading structure:", error);
                alert("Failed to load the 3D structure. Please try again later.");
            });
        });
        {% elif prediction.status == "pending" or prediction.status == "running" %}
        // Auto-refresh for pending or running predictions
        setTimeout(function () {
            window.location.reload();
        }, 10000); // Refresh every 10 seconds
        {% endif %}
    </script>
</body>

</html>